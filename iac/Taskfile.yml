version: '3'

vars:
  BACKEND_RG_NAME: "rg-terraform-state-dsrp4"
  BACKEND_LOCATION: "East US"
  CONTAINER_NAME: "tfstate"
  KEY_NAME: "mlops-dsrp4.terraform.tfstate"

tasks:
  default:
    desc: "Muestra las tareas disponibles"
    cmds:
      - task --list

  backend:setup:
    desc: "Crea el storage account y genera backend.hcl para Terraform"
    cmds:
      - |
        echo "ğŸš€ Creando backend de Terraform..."
        # Generar nombre Ãºnico para storage account
        RANDOM_SUFFIX=$(openssl rand -hex 4 | tr '[:upper:]' '[:lower:]')
        STORAGE_NAME="tfstatedsrp4${RANDOM_SUFFIX}"
        echo "ğŸ“¦ Storage Account: ${STORAGE_NAME}"
        
        # Verificar autenticaciÃ³n y suscripciÃ³n
        if ! az account show &> /dev/null; then
          echo "âš ï¸  Autenticando en Azure..."
          az login
        fi
        
        # Mostrar informaciÃ³n de la suscripciÃ³n activa
        echo ""
        echo "ğŸ“‹ InformaciÃ³n de la suscripciÃ³n:"
        SUBSCRIPTION_INFO=$(az account show --query '{Name:name, SubscriptionId:id, State:state}' -o tsv 2>&1)
        if [ $? -eq 0 ]; then
          echo "$SUBSCRIPTION_INFO" | awk '{print "   " $0}'
        else
          echo "âŒ Error: No se pudo obtener informaciÃ³n de la suscripciÃ³n"
          echo "$SUBSCRIPTION_INFO"
          exit 1
        fi
        echo ""
        
        # Verificar y registrar proveedores necesarios
        echo "0ï¸âƒ£ Verificando proveedores de Azure..."
        STORAGE_PROVIDER=$(az provider show --namespace Microsoft.Storage --query "registrationState" -o tsv 2>/dev/null)
        if [ "$STORAGE_PROVIDER" != "Registered" ]; then
          if [ "$STORAGE_PROVIDER" = "Registering" ]; then
            echo "   â³ El proveedor Microsoft.Storage se estÃ¡ registrando..."
            echo "   Esperando a que termine (puede tomar 1-5 minutos)..."
            az provider register --namespace Microsoft.Storage --wait
          else
            echo "   ğŸ“ Registrando proveedor Microsoft.Storage..."
            az provider register --namespace Microsoft.Storage --wait
          fi
          
          # Verificar que se registrÃ³ correctamente
          STORAGE_PROVIDER=$(az provider show --namespace Microsoft.Storage --query "registrationState" -o tsv 2>/dev/null)
          if [ "$STORAGE_PROVIDER" = "Registered" ]; then
            echo "âœ… Proveedor Microsoft.Storage registrado"
          else
            echo "âŒ Error: No se pudo registrar el proveedor Microsoft.Storage"
            echo "   Estado actual: $STORAGE_PROVIDER"
            exit 1
          fi
        else
          echo "âœ… Proveedor Microsoft.Storage ya estÃ¡ registrado"
        fi
        echo ""
        
        # Crear grupo de recursos
        echo "1ï¸âƒ£ Creando grupo de recursos..."
        if az group show --name "{{.BACKEND_RG_NAME}}" &> /dev/null; then
          echo "âœ… Grupo de recursos ya existe"
        else
          if az group create \
            --name "{{.BACKEND_RG_NAME}}" \
            --location "{{.BACKEND_LOCATION}}" \
            --output none; then
            echo "âœ… Grupo de recursos creado"
          else
            echo "âŒ Error al crear el grupo de recursos"
            exit 1
          fi
        fi
        
        # Crear storage account
        echo "2ï¸âƒ£ Creando storage account..."
        if az storage account show --name "${STORAGE_NAME}" --resource-group "{{.BACKEND_RG_NAME}}" &> /dev/null; then
          echo "âœ… Storage account ya existe: ${STORAGE_NAME}"
        else
          if az storage account create \
            --resource-group "{{.BACKEND_RG_NAME}}" \
            --name "${STORAGE_NAME}" \
            --sku Standard_LRS \
            --encryption-services blob \
            --location "{{.BACKEND_LOCATION}}" \
            --allow-blob-public-access false \
            --min-tls-version TLS1_2 \
            --output none; then
            echo "âœ… Storage account creado: ${STORAGE_NAME}"
          else
            echo "âŒ Error al crear el storage account"
            exit 1
          fi
        fi
        
        sleep 5
        
        # Configurar seguridad
        echo "3ï¸âƒ£ Configurando seguridad..."
        az storage account blob-service-properties update \
          --account-name "${STORAGE_NAME}" \
          --resource-group "{{.BACKEND_RG_NAME}}" \
          --enable-versioning true \
          --enable-delete-retention true \
          --delete-retention-days 30 \
          --output none
        
        # Crear container
        echo "4ï¸âƒ£ Creando container..."
        az storage container create \
          --name "{{.CONTAINER_NAME}}" \
          --account-name "${STORAGE_NAME}" \
          --auth-mode login \
          --output none || echo "âœ… Container ya existe"
        
        # Crear backend.hcl
        echo "5ï¸âƒ£ Creando backend.hcl..."
        {
          echo "resource_group_name  = \"{{.BACKEND_RG_NAME}}\""
          echo "storage_account_name = \"${STORAGE_NAME}\""
          echo "container_name       = \"{{.CONTAINER_NAME}}\""
          echo "key                  = \"{{.KEY_NAME}}\""
        } > backend.hcl
        
        echo ""
        echo "âœ… Backend creado exitosamente!"
        echo "ğŸ“ Storage Account: ${STORAGE_NAME}"
        echo ""
        echo "ğŸ’¡ Siguiente paso:"
        echo "   terraform init -backend-config=backend.hcl"

  dns:set-label:
    desc: "Asigna un DNS label al public IP del Service (frontend) en AKS"
    vars:
      SERVICE_NAME: "frontend"
      SERVICE_NS: "default"
      DNS_LABEL: "dsrp-frontend"
    cmds:
      - |
        set -euo pipefail
        echo "ğŸ” Obteniendo IP del Service {{.SERVICE_NAME}} (ns {{.SERVICE_NS}})..."
        IP=$(kubectl get svc "{{.SERVICE_NAME}}" -n "{{.SERVICE_NS}}" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        if [ -z "$IP" ]; then
          echo "âŒ No se encontrÃ³ IP pÃºblica en el Service. Â¿El LoadBalancer ya estÃ¡ aprovisionado?"
          exit 1
        fi
        echo "ğŸŒ IP: $IP"

        echo "ğŸ” Buscando el recurso Public IP en Azure..."
        read RG NAME <<<"$(az network public-ip list --query "[?ipAddress=='$IP'].[resourceGroup,name]" -o tsv | head -n1)"
        if [ -z "${RG:-}" ] || [ -z "${NAME:-}" ]; then
          echo "âŒ No se encontrÃ³ el Public IP $IP en Azure. Verifica la suscripciÃ³n/resource group."
          exit 1
        fi
        echo "ğŸ—‚ï¸  RG: $RG | IP name: $NAME"

        echo "ğŸ·ï¸  Asignando DNS label: {{.DNS_LABEL}}..."
        az network public-ip update \
          --resource-group "$RG" \
          --name "$NAME" \
          --dns-name "{{.DNS_LABEL}}" \
          --output none

        FQDN=$(az network public-ip show \
          --resource-group "$RG" \
          --name "$NAME" \
          --query "dnsSettings.fqdn" -o tsv)
        echo "âœ… Listo. FQDN: $FQDN"
